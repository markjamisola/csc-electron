<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saved Batches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
  </head>
  <body class="bg-gray-950 min-h-screen flex items-center justify-center p-8">
    <div class="bg-gray-900 rounded-2xl shadow-2xl p-10 w-full max-w-6xl">
      
      <!-- Header -->
      <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-extrabold text-yellow-400 flex items-center gap-2">
          <i data-feather="archive"></i> Saved Batches
        </h1>
        <a href="index.html" 
           class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800">
          ‚Üê Back
        </a>
      </div>

      <!-- Container for batches -->
      <div id="savedBatchesContainer" class="space-y-6"></div>
    </div>

    <script>
      feather.replace();

      async function fetchAndDisplayBatches() {
        const response = await fetch("http://127.0.0.1:8000/batches/");
        if (!response.ok) {
          document.getElementById("savedBatchesContainer").innerHTML = 
            `<p class="text-red-400">Failed to load batches.</p>`;
          return;
        }

        const batches = await response.json();
        const container = document.getElementById("savedBatchesContainer");
        container.innerHTML = "";

        if (batches.length === 0) {
          container.innerHTML = `<p class="text-gray-400">No saved batches found.</p>`;
          return;
        }

        batches.forEach(batch => {
          const card = document.createElement("div");
          card.className = "bg-gray-800 p-6 rounded-xl shadow-lg";

          card.innerHTML = `
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-green-400">
                Batch #${batch.id} - ${batch.name}
              </h2>
              <div class="flex gap-2">
                <button onclick="viewBatchImages(${batch.id})" 
                  class="px-3 py-1 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700">
                  View Images
                </button>
                <button onclick="exportBatch(${batch.id})"
                  class="px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700">
                  Export Batch
                </button>
                <button onclick="deleteBatch(${batch.id})" 
                  class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700">
                  Delete Batch
                </button>
              </div>
            </div>
            <p class="text-gray-400 mt-1">Filter: ${batch.filter || "N/A"}</p>
            <div id="batchImages-${batch.id}" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4 hidden"></div>
          `;
          container.appendChild(card);
        });
      }

      async function viewBatchImages(batchId) {
        const response = await fetch(`http://127.0.0.1:8000/batches/${batchId}/images`);
        const images = await response.json();

        const imgContainer = document.getElementById(`batchImages-${batchId}`);
        imgContainer.innerHTML = "";

        if (images.length === 0) {
          imgContainer.innerHTML = `<p class="text-gray-400">No images saved in this batch.</p>`;
        } else {
          images.forEach(img => {
            const wrapper = document.createElement("div");
            wrapper.className = "relative group";

            const imgEl = document.createElement("img");
            imgEl.src = `http://127.0.0.1:8000/images/${img.id}/file`;
            imgEl.className = "w-full h-40 object-cover rounded-lg border border-gray-600";

            // Delete photo button
            const deleteBtn = document.createElement("button");
            deleteBtn.innerText = "√ó";
            deleteBtn.className =
              "absolute top-2 right-2 bg-red-600 text-white w-8 h-8 rounded-full hidden group-hover:flex items-center justify-center hover:bg-red-700";
            deleteBtn.onclick = () => deleteImage(img.id, batchId);

            wrapper.appendChild(imgEl);
            wrapper.appendChild(deleteBtn);
            imgContainer.appendChild(wrapper);
          });
        }

        imgContainer.classList.toggle("hidden");
      }

      // üîπ Delete batch
      async function deleteBatch(batchId) {
        if (!confirm("Are you sure you want to delete this batch?")) return;

        const response = await fetch(`http://127.0.0.1:8000/batches/${batchId}`, {
          method: "DELETE"
        });

        if (response.ok) {
          alert("Batch deleted successfully.");
          fetchAndDisplayBatches();
        } else {
          alert("Failed to delete batch.");
        }
      }

      // üîπ Delete single image
      async function deleteImage(imageId, batchId) {
        if (!confirm("Delete this image?")) return;

        const response = await fetch(`http://127.0.0.1:8000/images/${imageId}`, {
          method: "DELETE"
        });

        if (response.ok) {
          alert("Image deleted successfully.");
          viewBatchImages(batchId); // Refresh batch images
        } else {
          alert("Failed to delete image.");
        }
      }

      async function exportBatch(batchId) {
        const response = await fetch(`http://127.0.0.1:8000/batches/${batchId}/export`);
        if (!response.ok) {
          alert("Failed to export batch.");
          return;
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `batch_${batchId}_images.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      }

      fetchAndDisplayBatches();
    </script>
  </body>
</html>
