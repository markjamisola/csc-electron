<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Processing Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
  </head>
  <body class="bg-gray-900 min-h-screen text-white">
    <!-- Header -->
    <div class="bg-gray-800 shadow-lg">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <h1 class="text-2xl font-bold text-green-400 flex items-center gap-2">
          <i data-feather="image" class="w-6 h-6"></i>
          Image Processing Studio
        </h1>
        <p class="text-gray-400 text-sm">Professional image processing with OpenCV</p>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-6">
      <!-- Batch Management Section -->
      <div id="batchSection" class="mb-8">
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-green-400 flex items-center gap-2">
              <i data-feather="folder" class="w-5 h-5"></i>
              Current Batch
            </h2>
            <div class="flex gap-3">
              <button onclick="showBatchModal()" 
                class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                <i data-feather="plus" class="w-4 h-4"></i> New Batch
              </button>
              <a href="savedbatches.html" 
                class="flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition text-sm">
                <i data-feather="archive" class="w-4 h-4"></i> Saved Batches
              </a>
            </div>
          </div>
          
          <!-- Current Batch Info -->
          <div id="noBatchMessage" class="text-center py-8 text-gray-400">
            <i data-feather="folder-plus" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
            <p>No batch selected. Create a new batch to get started.</p>
          </div>
          
          <div id="currentBatchInfo" class="hidden">
            <div class="bg-gray-700 rounded-lg p-4 mb-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-semibold text-white" id="batchNameDisplay">Batch Name</h3>
                  <p class="text-sm text-gray-400">Batch ID: <span id="batchIdDisplay">-</span></p>
                </div>
                <div class="text-right">
                  <p class="text-sm text-gray-400">Images: <span id="imageCountDisplay">0</span></p>
                </div>
              </div>
            </div>
            
            <!-- File Upload Area -->
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-green-400 transition">
              <input type="file" id="fileInput" multiple accept="image/*" class="hidden" onchange="handleFileUpload()" />
              <label for="fileInput" class="cursor-pointer">
                <i data-feather="upload-cloud" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                <p class="text-gray-300 mb-2">Click to upload images or drag and drop</p>
                <p class="text-sm text-gray-500">Supports: JPG, PNG, GIF, BMP</p>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Image Gallery Section -->
      <div id="imageGallerySection" class="hidden mb-8">
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h2 class="text-xl font-semibold text-green-400 mb-4 flex items-center gap-2">
            <i data-feather="grid" class="w-5 h-5"></i>
            Image Gallery
          </h2>
          <div id="imageGallery" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <!-- Images will be displayed here -->
          </div>
        </div>
      </div>

      <!-- Image Processing Panel -->
      <div id="processingPanel" class="hidden">
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-green-400 flex items-center gap-2">
              <i data-feather="settings" class="w-5 h-5"></i>
              Image Processing
            </h2>
            <button onclick="closeProcessingPanel()" class="text-gray-400 hover:text-white">
              <i data-feather="x" class="w-5 h-5"></i>
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Selected Image Display -->
            <div class="lg:col-span-1">
              <h3 class="text-lg font-medium mb-3">Selected Image</h3>
              <div class="bg-gray-700 rounded-lg p-4">
                <img id="selectedImagePreview" class="w-full rounded-lg mb-3" />
                <div id="selectedImageInfo" class="text-sm text-gray-400">
                  <!-- Image info will be shown here -->
                </div>
              </div>
            </div>

            <!-- Processing Options -->
            <div class="lg:col-span-1">
              <h3 class="text-lg font-medium mb-3">Processing Options</h3>
              <div class="space-y-4">
                <!-- Image Information -->
                <div class="bg-gray-700 rounded-lg p-4">
                  <h4 class="font-medium mb-2 flex items-center gap-2">
                    <i data-feather="info" class="w-4 h-4"></i>
                    Image Information
                  </h4>
                  <button onclick="showImageDimensions()" 
                    class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                    Show Dimensions
                  </button>
                </div>

                <!-- Filters -->
                <div class="bg-gray-700 rounded-lg p-4">
                  <h4 class="font-medium mb-3 flex items-center gap-2">
                    <i data-feather="sliders" class="w-4 h-4"></i>
                    Apply Filter
                  </h4>
                  <select id="filterSelect" class="w-full px-3 py-2 rounded bg-gray-600 text-white border border-gray-500 mb-3">
                    <option value="grayscale">Grayscale</option>
                    <option value="canny">Edge Detection</option>
                    <option value="blur">Blur</option>
                  </select>
                  <button onclick="applyFilter()" 
                    class="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
                    Apply Filter
                  </button>
                </div>
              </div>
            </div>

            <!-- Results -->
            <div class="lg:col-span-1">
              <h3 class="text-lg font-medium mb-3">Results</h3>
              <div id="resultsArea" class="bg-gray-700 rounded-lg p-4 min-h-96">
                <div class="text-center text-gray-500 py-8">
                  <i data-feather="image" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                  <p>Results will appear here</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Batch Creation Modal -->
    <div id="batchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
      <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold text-green-400 mb-4 flex items-center gap-2">
          <i data-feather="folder-plus" class="w-5 h-5"></i>
          Create New Batch
        </h2>
        <div class="mb-4">
          <label class="block text-gray-300 mb-2" for="modalBatchName">Batch Name</label>
          <input id="modalBatchName" type="text" placeholder="Enter batch name..." 
            class="w-full px-4 py-3 rounded-lg border border-gray-600 bg-gray-700 text-gray-200 focus:ring-2 focus:ring-green-400 focus:border-transparent" />
        </div>
        <div class="flex justify-end gap-3">
          <button onclick="hideBatchModal()" 
            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
            Cancel
          </button>
          <button onclick="createBatch()" 
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            Create Batch
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize Feather icons
      feather.replace();
      
      // Global variables
      let currentBatchId = null;
      let currentBatchName = null;
      let selectedImageFile = null;
      let uploadedImages = [];

      // Batch Management Functions
      function showBatchModal() {
        document.getElementById("batchModal").classList.remove("hidden");
        document.getElementById("modalBatchName").focus();
      }

      function hideBatchModal() {
        document.getElementById("batchModal").classList.add("hidden");
        document.getElementById("modalBatchName").value = "";
      }

      async function createBatch() {
        const name = document.getElementById("modalBatchName").value.trim();
        if (!name) {
          alert("Please enter a batch name.");
          return;
        }

        try {
          const formData = new FormData();
          formData.append("name", name);

          const response = await fetch("http://127.0.0.1:8001/batches/", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error("Failed to create batch");
          }

          const data = await response.json();
          currentBatchId = data.id;
          currentBatchName = data.name;

          // Update UI
          document.getElementById("noBatchMessage").classList.add("hidden");
          document.getElementById("currentBatchInfo").classList.remove("hidden");
          document.getElementById("batchNameDisplay").textContent = name;
          document.getElementById("batchIdDisplay").textContent = data.id;
          document.getElementById("imageCountDisplay").textContent = "0";

          hideBatchModal();
          uploadedImages = [];
        } catch (error) {
          console.error("Error creating batch:", error);
          alert("Failed to create batch. Please try again.");
        }
      }

      // File Upload Functions
      function handleFileUpload() {
        const fileInput = document.getElementById("fileInput");
        const files = Array.from(fileInput.files);
        
        files.forEach(file => {
          const imageData = {
            file: file,
            name: file.name,
            size: file.size,
            url: URL.createObjectURL(file),
            id: Date.now() + Math.random() // Temporary ID
          };
          uploadedImages.push(imageData);
        });

        updateImageGallery();
        updateImageCount();
      }

      function updateImageGallery() {
        const gallery = document.getElementById("imageGallery");
        const gallerySection = document.getElementById("imageGallerySection");
        
        if (uploadedImages.length === 0) {
          gallerySection.classList.add("hidden");
          return;
        }

        gallerySection.classList.remove("hidden");
        gallery.innerHTML = "";

        uploadedImages.forEach((imageData, index) => {
          const imageCard = document.createElement("div");
          imageCard.className = "bg-gray-700 rounded-lg p-2 hover:bg-gray-600 transition cursor-pointer";
          imageCard.onclick = () => selectImage(imageData, index);
          
          imageCard.innerHTML = `
            <img src="${imageData.url}" alt="${imageData.name}" class="w-full h-24 object-cover rounded mb-2">
            <p class="text-xs text-gray-300 truncate">${imageData.name}</p>
            <p class="text-xs text-gray-500">${(imageData.size / 1024).toFixed(1)} KB</p>
          `;
          
          gallery.appendChild(imageCard);
        });
      }

      function updateImageCount() {
        document.getElementById("imageCountDisplay").textContent = uploadedImages.length;
      }

      // Image Selection and Processing
      function selectImage(imageData, index) {
        selectedImageFile = imageData;
        
        // Show processing panel
        document.getElementById("processingPanel").classList.remove("hidden");
        
        // Update selected image preview
        document.getElementById("selectedImagePreview").src = imageData.url;
        document.getElementById("selectedImageInfo").innerHTML = `
          <p><strong>Name:</strong> ${imageData.name}</p>
          <p><strong>Size:</strong> ${(imageData.size / 1024).toFixed(1)} KB</p>
        `;
        
        // Clear previous results
        document.getElementById("resultsArea").innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <i data-feather="image" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
            <p>Results will appear here</p>
          </div>
        `;
        feather.replace();
      }

      function closeProcessingPanel() {
        document.getElementById("processingPanel").classList.add("hidden");
        selectedImageFile = null;
      }

      // Processing Functions
      async function showImageDimensions() {
        if (!selectedImageFile) {
          alert("Please select an image first.");
          return;
        }

        const img = new Image();
        img.onload = function() {
          const resultsArea = document.getElementById("resultsArea");
          resultsArea.innerHTML = `
            <div class="bg-blue-900 bg-opacity-30 rounded-lg p-4">
              <h4 class="font-semibold text-blue-400 mb-3 flex items-center gap-2">
                <i data-feather="info" class="w-4 h-4"></i>
                Image Dimensions
              </h4>
              <div class="space-y-2 text-sm">
                <p><strong>Height:</strong> ${this.naturalHeight} pixels</p>
                <p><strong>Width:</strong> ${this.naturalWidth} pixels</p>
                <p><strong>Aspect Ratio:</strong> ${(this.naturalWidth / this.naturalHeight).toFixed(2)}</p>
                <p><strong>File Size:</strong> ${(selectedImageFile.size / 1024).toFixed(1)} KB</p>
                <p><strong>Total Pixels:</strong> ${(this.naturalHeight * this.naturalWidth).toLocaleString()}</p>
              </div>
            </div>
          `;
          feather.replace();
        };
        img.src = selectedImageFile.url;
      }

      async function applyFilter() {
        if (!selectedImageFile || !currentBatchId) {
          alert("Please select an image and create a batch first.");
          return;
        }

        const filter = document.getElementById("filterSelect").value;
        const formData = new FormData();
        formData.append("file", selectedImageFile.file);
        formData.append("operation", filter);
        formData.append("batch_id", currentBatchId);

        try {
          const response = await fetch("http://127.0.0.1:8001/process-with-info/", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error("Failed to process image");
          }

          const result = await response.json();
          
          const resultsArea = document.getElementById("resultsArea");
          resultsArea.innerHTML = `
            <div class="space-y-4">
              <div class="bg-green-900 bg-opacity-30 rounded-lg p-4">
                <h4 class="font-semibold text-green-400 mb-3 flex items-center gap-2">
                  <i data-feather="check-circle" class="w-4 h-4"></i>
                  Filter Applied: ${filter}
                </h4>
                <img src="${result.image_data}" alt="Processed" class="w-full rounded-lg mb-3">
                <div class="text-sm space-y-1">
                  <p><strong>Original:</strong> ${result.original_dimensions.formatted}</p>
                  <p><strong>Processed:</strong> ${result.processed_dimensions.formatted}</p>
                </div>
              </div>
            </div>
          `;
          feather.replace();
        } catch (error) {
          console.error("Error processing image:", error);
          alert("Failed to process image. Please try again.");
        }
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function() {
        feather.replace();
      });
    </script>
  </body>
</html>